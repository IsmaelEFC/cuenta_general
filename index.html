<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#006341" />
  <meta name="description" content="Aplicación para el control de personal del Departamento de Investigación de Organizaciones Criminales" />
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cuenta OS9">
  <link rel="manifest" href="./manifest.json" />
  <link rel="shortcut icon" href="./icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="logo"><img src="./icons/os9.png" alt="OS9 Logo" class="logo-img"></div>
      <h1>Cuenta Diaria</h1>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <!-- Contenido principal de la aplicación -->
      <div id="contenedor">
        <!-- Las secciones se generarán dinámicamente aquí -->
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="total-general" id="totalGeneralFooter">
        Personal formando: <span id="totalGeneral">0</span>
      </div>
      <div class="button-group">
        <button id="resetear-dia" class="reset-btn">Reiniciar Día</button>
        <button id="generar-informe" class="report-btn">Generar Informe Final</button>
      </div>
    </div>
  </footer>

  <!-- Modal de Informe -->
  <div id="modalInforme" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Cuenta General</h2>
        <div class="fecha-informe" id="fechaInforme"></div>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body" id="informeContenido">
        <!-- Contenido del informe se generará dinámicamente -->
      </div>
      <div class="modal-footer">
        <button class="export-pdf-btn" id="exportar-pdf">Exportar a PDF</button>
        <button class="share-whatsapp-btn" id="compartir-whatsapp">Compartir por WhatsApp</button>
      </div>
    </div>
  </div>

  <!-- Contenedor oculto para la generación de PDF -->
  <div id="pdfContainer" class="pdf-container"></div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="pwa-install.js"></script>
  <script src="script.js" type="module"></script>
  <script src="table-scroll.js"></script>
</body>
  <!-- Inicialización de la aplicación -->
  <script>
    // Mover las funciones al ámbito global temporalmente
    window.abrirInforme = function() {
      const modal = document.getElementById('modalInforme');
      if (modal) modal.style.display = 'block';
    };

    window.cerrarInforme = function() {
      const modal = document.getElementById('modalInforme');
      if (modal) modal.style.display = 'none';
    };
    
    window.exportarPDF = function() {
      const element = document.getElementById('informeContenido');
      if (!element || !window.jsPDF) {
        console.error('No se pudo generar el PDF: elemento o jsPDF no disponible');
        return;
      }
      
      // Mostrar mensaje de carga
      const loadingMessage = document.createElement('div');
      loadingMessage.textContent = 'Generando PDF...';
      loadingMessage.style.position = 'fixed';
      loadingMessage.style.top = '50%';
      loadingMessage.style.left = '50%';
      loadingMessage.style.transform = 'translate(-50%, -50%)';
      loadingMessage.style.padding = '20px';
      loadingMessage.style.background = 'rgba(0,0,0,0.8)';
      loadingMessage.style.color = 'white';
      loadingMessage.style.borderRadius = '5px';
      loadingMessage.style.zIndex = '1000';
      document.body.appendChild(loadingMessage);
      
      // Usar html2canvas para capturar el contenido
      html2canvas(element, {
        scale: 2, // Mejor calidad
        useCORS: true,
        allowTaint: true,
        scrollX: 0,
        scrollY: 0
      }).then(canvas => {
        // Crear PDF
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jsPDF({
          orientation: 'landscape',
          unit: 'mm'
        });
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        
        // Guardar el PDF
        pdf.save('informe-os9.pdf');
        
        // Eliminar mensaje de carga
        document.body.removeChild(loadingMessage);
      }).catch(error => {
        console.error('Error al generar el PDF:', error);
        if (document.body.contains(loadingMessage)) {
          document.body.removeChild(loadingMessage);
        }
        alert('Error al generar el PDF. Por favor, inténtelo de nuevo.');
      });
    };
    
    window.compartirWhatsapp = function() {
      const element = document.getElementById('informeContenido');
      if (!element) {
        console.error('No se pudo compartir: elemento no encontrado');
        return;
      }
      
      // Mostrar mensaje de carga
      const loadingMessage = document.createElement('div');
      loadingMessage.textContent = 'Preparando para compartir...';
      loadingMessage.style.position = 'fixed';
      loadingMessage.style.top = '50%';
      loadingMessage.style.left = '50%';
      loadingMessage.style.transform = 'translate(-50%, -50%)';
      loadingMessage.style.padding = '20px';
      loadingMessage.style.background = 'rgba(0,0,0,0.8)';
      loadingMessage.style.color = 'white';
      loadingMessage.style.borderRadius = '5px';
      loadingMessage.style.zIndex = '1000';
      document.body.appendChild(loadingMessage);
      
      // Obtener todos los datos del informe
      const titulo = document.querySelector('.modal-title')?.textContent || 'Informe de Personal';
      const fecha = new Date().toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      
      // Capturar el contenido como imagen
      html2canvas(element, {
        scale: 1,
        useCORS: true,
        allowTaint: true,
        scrollX: 0,
        scrollY: 0,
        logging: false,
        scale: 2 // Mejor calidad
      }).then(canvas => {
        // Convertir a formato base64
        const imageData = canvas.toDataURL('image/jpeg', 0.9);
        
        // Obtener el texto de la tabla
        let tableText = '';
        const rows = element.querySelectorAll('tr');
        rows.forEach((row, rowIndex) => {
          const cells = row.querySelectorAll('th, td');
          const rowData = Array.from(cells).map(cell => cell.textContent.trim()).join(' | ');
          tableText += rowData + '\n';
          if (rowIndex === 0) { // Después del encabezado, agregar separador
            tableText += '-'.repeat(50) + '\n';
          }
        });
        
        // Crear el mensaje detallado
        const mensajeCompleto = `*${titulo}*\n` +
                              `Fecha: ${fecha}\n\n` +
                              '```\n' + // Usar formato de código para mantener el formato
                              tableText +
                              '```\n\n' +
                              'Informe generado desde la aplicación OS9';
        
        // Codificar el mensaje para la URL
        const mensajeCodificado = encodeURIComponent(mensajeCompleto);
        
        // Crear la URL de WhatsApp con el mensaje
        const urlWhatsApp = `https://wa.me/?text=${mensajeCodificado}`;
        
        // Abrir WhatsApp en una nueva pestaña
        const newWindow = window.open(urlWhatsApp, '_blank');
        
        // Si no se pudo abrir WhatsApp (puede pasar en algunos navegadores móviles)
        if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
          // Crear un enlace temporal para la imagen
          const link = document.createElement('a');
          link.download = `informe-os9-${fecha.replace(/\//g, '-')}.jpg`;
          link.href = imageData;
          
          // Mostrar instrucciones
          const mensajeAlternativo = `${mensajeCompleto}\n\n` +
                                   'No se pudo abrir WhatsApp automáticamente. ' +
                                   'Por favor, copie el mensaje anterior y la imagen para compartir manualmente.';
          
          // Copiar la imagen al portapapeles
          canvas.toBlob(blob => {
            const item = new ClipboardItem({ 'image/jpeg': blob });
            navigator.clipboard.write([item]).then(() => {
              alert(mensajeAlternativo);
            }).catch(err => {
              console.error('Error al copiar al portapapeles:', err);
              alert(mensajeAlternativo + '\n\nError al copiar la imagen al portapapeles.');
            });
          });
        }
        
        // Eliminar mensaje de carga
        document.body.removeChild(loadingMessage);
        
      }).catch(error => {
        console.error('Error al generar la imagen para compartir:', error);
        if (document.body.contains(loadingMessage)) {
          document.body.removeChild(loadingMessage);
        }
        
        // Si falla la generación de la imagen, enviar solo el texto
        const titulo = document.querySelector('.modal-title')?.textContent || 'Informe de Personal';
        const fecha = new Date().toLocaleDateString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
        
        let tableText = '';
        const rows = element.querySelectorAll('tr');
        rows.forEach((row, rowIndex) => {
          const cells = row.querySelectorAll('th, td');
          const rowData = Array.from(cells).map(cell => cell.textContent.trim()).join(' | ');
          tableText += rowData + '\n';
          if (rowIndex === 0) {
            tableText += '-'.repeat(50) + '\n';
          }
        });
        
        const mensajeCompleto = `*${titulo}*\n` +
                              `Fecha: ${fecha}\n\n` +
                              '```\n' +
                              tableText +
                              '```\n\n' +
                              'Informe generado desde la aplicación OS9';
        
        const mensajeCodificado = encodeURIComponent(mensajeCompleto);
        const urlWhatsApp = `https://wa.me/?text=${mensajeCodificado}`;
        window.open(urlWhatsApp, '_blank');
        
        alert('Se produjo un error al generar la imagen. Se ha compartido solo el texto.');
      });
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar jsPDF
      try {
        if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
          window.jsPDF = window.jspdf.jsPDF;
          console.log('jsPDF inicializado correctamente');
        } else if (typeof jsPDF !== 'undefined') {
          window.jsPDF = jsPDF;
          console.log('jsPDF inicializado desde el objeto global');
        } else {
          console.error('No se encontró la biblioteca jsPDF');
        }
      } catch (error) {
        console.error('Error al inicializar jsPDF:', error);
      }
      
      // Configurar event listeners
      const resetearBtn = document.getElementById('resetear');
      const generarInformeBtn = document.getElementById('generar-informe');
      const cerrarModalBtn = document.querySelector('.close');
      const exportarPdfBtn = document.getElementById('exportar-pdf');
      const compartirWhatsappBtn = document.getElementById('compartir-whatsapp');
      
      if (resetearBtn) resetearBtn.addEventListener('click', resetear);
      if (generarInformeBtn) generarInformeBtn.addEventListener('click', window.abrirInforme);
      if (cerrarModalBtn) cerrarModalBtn.addEventListener('click', window.cerrarInforme);
      if (exportarPdfBtn) exportarPdfBtn.addEventListener('click', exportarPDF);
      if (compartirWhatsappBtn) compartirWhatsappBtn.addEventListener('click', compartirWhatsapp);
      
      // Cerrar modal al hacer clic fuera del contenido
      const modal = document.getElementById('modalInforme');
      if (modal) {
        window.addEventListener('click', (event) => {
          if (event.target === modal) {
            window.cerrarInforme();
          }
        });
      }
    });
  </script>
</body>
</html>
